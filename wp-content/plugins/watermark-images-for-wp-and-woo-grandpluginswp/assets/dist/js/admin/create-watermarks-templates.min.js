(()=>{function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}!function(a){"use strict";var r="gpls-wmfw-watermark-image-for-wordpress",i="gpls_wmfw_watermark_image_for_wordpress",n=window[i+"_localize_vars"],o=null,s={},d={},l=null,c=!1,p=0,m=0;a.fn.resized=function(e,t){a(this).resize((function(){var r=a(this);r.data("resizeTimeout")&&clearTimeout(r.data("resizeTimeout")),r.data("resizeTimeout",setTimeout(e,t))}))},a(document).on("ready",(function(){var e;a("#visibility").remove(),d.width=window.outerWidth,d.height=window.outerHeight,[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map((function(e){return new bootstrap.Tooltip(e)})),[].slice.call(document.querySelectorAll(".accordion-collapse")).map((function(e){return new bootstrap.Collapse(e,{toggle:!1})})),a(".gpls-wmfw-open-gallery-btn").on("click",(function(i){i.preventDefault();var d=a(this).data("context"),l={title:"select-watermark"===d?n.labels.select_watermark:n.labels.select_image,library:t({orderby:"date",query:!0,post_mime_type:["image/png","image/jpg","image/jpeg","image/bmp","image/tiff","image/x-icon","image/heic"]},r+"-context-modal",d),button:{text:"select-watermark"===d?n.labels.select_watermark:n.labels.select_image},multiple:!1};(e=wp.media(l)).open(),e.on("select",(function(){var t=e.state().get("selection").toJSON();"select-preview-image"===d?(s=t[0],a(".select-watermark-btn-section").removeClass("d-none"),a(".selected-preview-img-id").val(s.id),o.initImage()):"select-watermark"===d&&(p++,m++,o.addWatermark("image",t[0],!0))}))})),(o=new h).initCurrentPreview(),o.initCurrentWatermarks(),a(".cpt-terms-select").each((function(e){f(a(this).attr("id"),a(this).data("cpt"),a(this).data("tax"))})),a(".cpt-author-select").each((function(e){u(a(this).attr("id"))}))}));var h=function(){function d(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),this.canvas=document.createElement("canvas"),this.activePlaceholder=null,this.editsElement=a(".preview-selected-wrapper .edits"),this.watermarks={},this.watermarksElements={},this.lastTextDegree=0,this.spotsMapping={tl:{left:0,top:0},tm:{left:1,top:0},tr:{left:2,top:0},ml:{left:0,top:1},mm:{left:1,top:1},mr:{left:2,top:1},bl:{left:0,top:2},bm:{left:1,top:2},br:{left:2,top:2}},this.events()}var h,w;return h=d,w=[{key:"events",value:function(){var e=this;a(".edits").on("click",".edits-close",(function(e){a(".preview-selected-wrapper .edits").addClass("d-none")})),a(document).on("mouseenter",".actions",(function(e){a(e.target).removeClass("d-none")})),a(document).on("click",".watermark-placeholder",(function(t){var r=a(t.target),i=(r.hasClass(".watermark-placeholder")?r:r.closest(".watermark-placeholder")).attr("item"),n=a('.watermark-placeholder[item="'+i+'"]');e.activateWatermarkSpecsItem(i),n.css("zIndex",200),n.siblings(".watermark-placeholder").css("zIndex",2)})),a(document).on("click",".accordion-button",(function(e){var t=a(e.target).data("id"),r=a('.watermark-placeholder[item="'+t+'"]');r.css("zIndex",200),r.siblings(".watermark-placeholder").css("zIndex",2)})),a(document).on("mouseenter","#selected-preview-container",(function(e){a(".watermark-placeholder").find(".actions").removeClass("d-none")})),a(document).on("mouseleave","#selected-preview-container",(function(e){a(".watermark-placeholder").find(".actions").addClass("d-none")})),a(document).on("keypress",".watermark-text-textarea",(function(e){13===e.which&&e.preventDefault()})),a(document).on("keyup",".watermark-text-textarea",(function(t){var r=a(t.target),i=r.parents(".watermark-placeholder-text").attr("item"),n=e.watermarks[i];a("#"+i+"_specs").find(".edit-title").val(r.text()),n=e.updateWatermarkTextOffsets(n),e.repeatWatermarkPlaceholder(n)})),a(document).on("mousedown",".watermark-placeholder-rotate-handle",(function(e){a(e.target).parents(".watermark-placeholder").rotatable("instance").startRotate(e)})),a(document).on("click",".actions .action-edit",(function(t){var r=a(t.target).closest(".watermark-placeholder").attr("item");e.activateWatermarkSpecsItem(r)})),a(document).on("click",".watermark-specs-header",(function(e){var t=a(e.target).data("id"),r=a('.watermark-placeholder[item="'+t+'"]');r.length&&(r.find(".actions").removeClass("d-none"),r.siblings().find(".actions").addClass("d-none"))})),a(document).on("click",".accordion-item .action-remove",(function(t){if(confirm(n.labels.remove_watermark)){var r=a(t.target).closest(".accordion-item").data("id");p--,e.removeWatermark(r)}})),a(document).on("click",".actions .action-remove",(function(t){if(confirm(n.labels.remove_watermark)){var r=a(t.target).parents(".watermark-placeholder").attr("item");p--,e.removeWatermark(r)}})),a(document).on("input change",".watermark-specs .edit",(function(t,i){i!==r+"-pypass-repeat"&&clearTimeout(l),l=setTimeout((function(){var r=a(t.target),i=r.data("type"),n=r.val(),o=r.closest(".accordion-item").data("id"),s=e.watermarks[o],d=a('.watermark-placeholder[item="'+o+'"]'),l=a("#"+o+"_specs"),c=s.styles;if("opacity"===i||"degree"===i){if(isNaN(n))return;if("text"===s.type){if(n>90&&n<270)return n=n<e.lastTextDegree?90:270,e.lastTextDegree=n,void l.find(".edit-degree").val(n).trigger("change");e.lastTextDegree=n}c[i]="degree"===i&&n<0?360-Math.abs(n):n}else if("position-type"===i){var p=l.find("."+n+"-position");p.collapse("show"),p.siblings(".position-type-input").collapse("hide"),s=e.updateWatermark(s,{position:{positionType:n}})}else if("position-left-percent"===i){if(isNaN(n))return;s=e.updateWatermark(s,{position:{leftPercent:n}})}else if("position-top-percent"===i){if(isNaN(n))return;s=e.updateWatermark(s,{position:{topPercent:n}})}else if("position-spot"===i)s=e.updateWatermark(s,{position:{positionSpot:n}});else if("position-left"===i){if(isNaN(n))return;s=e.updateWatermark(s,{position:{left:n}})}else if("position-top"===i){if(isNaN(n))return;s=e.updateWatermark(s,{position:{top:n}})}else"position-center-offset"===i?s=e.updateWatermark(s,{position:{centerOffset:r.is(":checked")}}):"width"===i?s=e.updateWatermark(s,{width:n}):"height"===i?s=e.updateWatermark(s,{height:n}):c.font[i]=n;"title"===i&&(s=e.updateWatermark(s,{text:n}),d.find(".watermark-text-textarea").text(n)),e.updateWatermarkPlaceholderStyles(d,c,s),"text"===(s=e.updateWatermarkStyles(s,c)).type&&(s=e.updateWatermarkTextOffsets(s)),e.updateWatermarkPlaceholderStyles(d,c,s),e.repeatWatermarkPlaceholder(s)}),200)})),a(document).on(i+"_preview_watermark_save_toggle",(function(e,t){t?(a(".preview-watermark-preview-btn").removeClass("disabled").prop("disabled",!1),a(".preview-watermark-preview-btn").removeClass("d-none")):(a(".preview-watermark-preview-btn").addClass("disabled").prop("disabled",!0),a(".preview-watermark-preview-btn").addClass("d-none"))})),a(document).on("click",".gpls-wmfw-add-text-watermark",(function(e){e.preventDefault(),p++,m++,o.addWatermark("text",{},!0)})),a(document).on("input",".watermark-text-textarea",(function(t){if(13!==t.keyCode){var r=a(t.target),i=r.parents(".watermark-placeholder-text").attr("item"),n=e.watermarks[i],o=r.text();e.updateWatermark(n,{text:o}),e.updateWatermarkStyles(n,n.styles)}else t.preventDefault()})),a(document).on("click",".preview-watermark-preview-btn",(function(t){e.previewWatermarks(t)})),a(document).on("change",".edit-position-repeat-status",(function(t){var r=a(t.target),i=r.is(":checked"),n=r.data("watermarkid"),o=a("#"+n+"_specs"),s=e.watermarks[n];o.find(".repeat-axis-wrapper").collapse(i?"show":"hide"),s.isRepeat=i,e.directUpdateWatermark(s),e.repeatWatermarkPlaceholder(s)})),a(document).on("change",".repeat-axis-select",(function(t){var r=a(t.target),i=r.val(),n=r.data("watermarkid"),o=e.watermarks[n];o.repeatAxis=i,e.directUpdateWatermark(o),e.repeatWatermarkPlaceholder(o)})),a(document).on("change",".repeat-axis-offset-input",(function(t){var r=a(t.target),i=r.val(),n=r.data("watermarkid"),o=r.data("axistype"),s=e.watermarks[n];"x"===o?s.repeatXAxisOffset=i:s.repeatYAxisOffset=i,e.directUpdateWatermark(s),e.repeatWatermarkPlaceholder(s)})),a(document).on("change",".auto-apply-status",(function(e){var t=a(e.target).is(":checked"),r=a("#apply-type-overwrite").is(":checked"),i=a(".auto-apply-context").is(":checked");a(".step-2").collapse(t?"show":"hide"),t&&r&&a(".create-backup").collapse("show"),t&&i&&a(".step-3").collapse("show"),t||a(".step-3").collapse("hide")})),a(document).on("change",".auto-apply-img-dimension-status",(function(e){var t=a(e.target).is(":checked");a(".auto-apply-img-dimension").collapse(t?"show":"hide")})),a(document).on("change",".auto-apply-context",(function(e){var t=a(".auto-apply-context").is(":checked");a(".step-3").collapse(t?"show":"hide")})),a(document).on("change",".auto-apply-context-posts",(function(e){var t=a(e.target).is(":checked");a("#auto-apply-context-filter-posts").collapse(t?"show":"hide")})),a(document).on("change",".context-posts-cpt",(function(e){var t=a(e.target),r=t.val(),i=t.is(":checked");a(".context-by-cpt-filter-"+r).collapse(i?"show":"hide")})),a(document).on("change",".apply-type-select .apply-type",(function(e){"overwrite"===a(".apply-type:checked").val()?a(".create-backup").collapse("show"):a(".create-backup").collapse("hide")})),a(document).on("click",".add-filter-rule-group",(function(t){t.preventDefault();var r=a(t.target),i=r.data("cpt"),n=r.data("counter");e.getFilterRow(r,i,n)})),a(document).on("click",".remove-group-rule",(function(e){e.preventDefault(),a(e.target).parents(".rule-group-row").remove()})),a(window).on("resize",(function(e){a(".preview-result").addClass("d-none")})),a(window).resized((function(t){var r=a(".selected-preview");s.width=Math.floor(r.width()),s.height=Math.floor(r.height()),e.initCurrentWatermarks(!1,!0)}),300)}},{key:"calculatePosition",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";t.length||(t=e.positionType);var a=this.spotsMapping[e.positionSpot],r=Math.round(s.width/3),i=Math.round(s.height/3);if("pixel"===t)var n={left:Math.round(a.left*r)+parseInt(e.absLeft),top:Math.round(a.top*i)+parseInt(e.absTop)};else"percent"===t&&(n={left:Math.round(a.left*r)+parseInt(r*parseFloat(e.leftPercent/100)),top:Math.round(a.top*i)+parseInt(i*parseFloat(e.topPercent/100))});return e.centerOffset&&(n.left-=Math.round(e.width/2),n.top-=Math.round(e.height/2)),n}},{key:"initCurrentPreview",value:function(){s=n.current_watermarks.preview?n.current_watermarks.preview:n.current_watermarks.default_preview;var e=a(".selected-preview");s.width=Math.floor(e.width()),s.height=Math.floor(e.height())}},{key:"initCurrentWatermarks",value:function(){var e,t=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(r){if(null!=n&&null!==(e=n.current_watermarks)&&void 0!==e&&e.watermarks){var o=n.current_watermarks.watermarks;p=Object.keys(o).length,m=Object.keys(o).length}}else o=this.watermarks;o&&(c=!0,a.each(o,(function(e,r){i&&t.removeWatermark(r.id,!0),t.addWatermark(r.type,r,!1,r,!1),t.initWatermarkSpecs(r.id);var n=a('.watermark-placeholder[item="'+r.id+'"]');t.updateWatermarkPlaceholderStyles(n,r.styles,r),"text"===r.type&&(n.find(".watermark-text-textarea").text(r.text),t.updateWatermarkTextOffsets(r)),t.updateWatermarkStyles(r.id,r.styles),t.updateWatermarkSpecs(r.id,r),t.repeatWatermarkPlaceholder(r)})),c=!1)}},{key:"updateCurrentWatermarksPosition",value:function(){var e=this;a.each(this.watermarks,(function(t,r){"pixel"===r.positionType?(r.absLeft,r.absTop):(r.topPercent,r.leftPercent);var i=a('.watermark-placeholder[item="'+r.id+'"]');e.updateWatermarkPlaceholderStyles(i,r.styles,r)}))}},{key:"activateWatermarkSpecsItem",value:function(e){var t=a('.accordion-button[data-id="'+e+'"]');t&&t.hasClass("collapsed")&&t.trigger("click")}},{key:"insertWatermarkToList",value:function(e){var t=a("#"+r+"-added-watermarks-list");if(t.length){t.find(".watermarks-list-accordion").append(this.watermarksAccordionItemHTML(e,p));var i=a(".watermark-specs-placeholder").clone().attr("id","watermark-specs-item-"+e.id).removeClass("watermark-specs-placeholder").addClass("watermark-specs").removeClass("d-none");i.append(this.watermarkAccordionInputs(e)),a("#"+e.id+"_specs").find(".accordion-body").html(i),this.initWatermarkSpecs(e.id),a('.watermark-placeholder[item="'+e.id+'"]').find(".watermark-placeholder-wrapper").trigger("click")}}},{key:"watermarksAccordionItemHTML",value:function(e,t){var a=e.id;return'<div class="accordion-item" data-id="'+a+'" >\n            <h4 class="accordion-header watermark-specs-header" id="'+a+'_header" data-index="'+(t-1)+'" data-id="'+a+'">\n                <div class="header-wrapper d-flex flex-row align-items-center" style="height: 60px;">\n                    <button class="accordion-button collapsed" type="button" data-id="'+a+'" data-bs-toggle="collapse" data-bs-target="#'+a+'_specs" aria-expanded="true" aria-controls="'+a+'_specs" >\n                        Watermark '+m+" ["+this.watermarks[a].type+']\n                    </button>\n                    <span class="dashicons dashicons-dismiss action action-remove mx-2 bg-white" style="color:#F00;" type="button" data-id="'+a+'"></span>\n                </div>\n            </h4>\n            <div id="'+a+'_specs" class="accordion-collapse collapse" data-id="'+a+'" aria-labelledby="'+a+'_header" data-bs-parent="#gpls-wmfw-watermarks-list-accordion" >\n                <div class="accordion-body">\n                </div>\n            </div>\n            </div>'}},{key:"watermarkAccordionInputs",value:function(e){var t=e.id;return'<input type="hidden" name="watermarks['+t+'][type]" value="'+e.type+'" />\n            <input type="hidden" name="watermarks['+t+'][id]" value="'+t+'" />\n            '.concat("image"===e.type?'<input type="hidden" name="watermarks['+t+'][url]" value="'+e.url+'" />\n                <input type="hidden" name="watermarks['+t+'][imgID]" value="'+e.imgID+'" />':"","\n            ")}},{key:"initWatermarkSpecs",value:function(e){var t=a("#watermark-specs-item-"+e);if(t.length){var r=this.watermarks[e];"text"===r.type?(t.find(".edit.edit-title").val(r.text).attr("name","watermarks["+e+"][title]"),t.find(".edit.edit-color").val(r.styles.font.color).attr("name","watermarks["+e+"][color]"),t.find(".edit.edit-font-size").val(r.styles.font.fontSize).attr("name","watermarks["+e+"][fontsize]"),t.find(".edit.edit-font-family").val(r.styles.font.fontFamily).attr("name","watermarks["+e+"][fontfamily]"),t.find(".edit-position-botleft").val(r.botLeft).attr("name","watermarks["+e+"][botLeft]"),t.find(".edit-position-bottop").val(r.botTop).attr("name","watermarks["+e+"][botTop]"),t.find(".edit-position-exactwidth").val(r.exactWidth).attr("name","watermarks["+e+"][exactWidth]"),t.find(".edit-position-baselineoffset").val(r.baselineOffset).attr("name","watermarks["+e+"][baselineOffset]")):"image"===r.type&&t.find(".edit-text").remove(),"text"===r.type&&t.find(".watermark-dimension-wrapper").addClass("d-none"),t.find(".edit.edit-width").val(r.width).attr("name","watermarks["+e+"][width]"),t.find(".edit.edit-height").val(r.height).attr("name","watermarks["+e+"][height]");var i=t.find(".edit-opacity");i.val(r.styles.opacity).attr("name","watermarks["+e+"][opacity]"),i.trigger("change"),t.find(".gpls-wmfw-watermark-position-spot-"+r.positionSpot).prop("checked",!0),a.each(t.find(".edit-position-spot"),(function(t,r){a(r).attr("name","watermarks["+e+"][positionSpot]")})),t.find(".edit-position-type").attr("name","watermarks["+e+"][positionType]"),t.find(".edit-position-repeat-status").attr("name","watermarks["+e+"][isRepeat]").attr("data-watermarkid",e),t.find(".repeat-axis-select").attr("name","watermarks["+e+"][repeatAxis]").attr("data-watermarkid",e),t.find(".repeat-x-axis-offset-input").val(r.repeatXAxisOffset).attr("name","watermarks["+e+"][repeatXAxisOffset]").attr("data-watermarkid",e),t.find(".repeat-y-axis-offset-input").val(r.repeatYAxisOffset).attr("name","watermarks["+e+"][repeatYAxisOffset]").attr("data-watermarkid",e),t.find(".position-type-"+r.positionType).prop("checked",!0),t.find(".edit-position-center-offset").prop("checked",e.centerOffset),t.find(".edit-position-center-offset").attr("name","watermarks["+e+"][centerOffset]"),t.find(".edit-position-left").val(r.absLeft).attr("name","watermarks["+e+"][absLeft]"),t.find(".edit-position-top").val(r.absTop).attr("name","watermarks["+e+"][absTop]"),t.find(".edit-position-left-percent").val(r.leftPercent).attr("name","watermarks["+e+"][leftPercent]"),t.find(".edit-position-top-percent").val(r.topPercent).attr("name","watermarks["+e+"][topPercent]"),t.find(".edit-degree").val(r.styles.degree).attr("name","watermarks["+e+"][degree]"),t.find('[data-bs-toggle="tooltip"]').tooltip()}}},{key:"fillInWatermarkEditsList",value:function(e){"text"===e.type&&(this.editsElement.find(".edit-title").val(e.text),this.editsElement.find(".edit-color").val(e.styles.font.color),this.editsElement.find(".edit-font-size").val(e.styles.font.fontSize),this.editsElement.find(".edit-font-family").val(e.styles.font.fontFamily)),this.editsElement.find(".edit-opacity").val(e.styles.opacity).trigger("change")}},{key:"unique_id",value:function(){return"watermark_"+Math.round(Math.random()*Math.round(Math.random()*Date.now()))}},{key:"randomPosition",value:function(e,t){return Math.round(Math.random()*(t-e+1))+e}},{key:"initWaterMarkText",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this;if(e)var a=e;else{var r=n.labels.watermark+" "+m,i=function(){this.id=t.unique_id(),this.type="text",this.width=50,this.height=30,this.text=r,this.centerOffset=!1,this.isRepeat=!1,this.repeatAxis="",this.repeatXAxisOffset=200,this.repeatYAxisOffset=200,this.positionSpot="mm",this.positionType="pixel",this.absLeft=Math.round(50+50*Object.keys(t.watermarks).length),this.absTop=Math.round(50+50*Object.keys(t.watermarks).length),this.leftPercent=0,this.topPercent=0,this.baselineOffset=5,this.exactWidth=50,this.botLeft=0,this.botTop=0,this.styles={font:{color:"#000000",fontSize:16,fontFamily:"verdana",opacity:1},opacity:1,degree:0}};a=new i}return a}},{key:"initWaterMarkImg",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=this;if(t)var r=t;else{var i=!0;(e.width>s.width||e.height>s.height)&&(i=!1);var n=function(){this.id=a.unique_id(),this.type="image",this.width=i?e.width:150,this.sourceWidth=e.width,this.height=i?e.height:150,this.sourceHeight=e.height,this.imgID=e.id,this.centerOffset=!1,this.isRepeat=!1,this.repeatAxis="",this.repeatXAxisOffset=200,this.repeatYAxisOffset=200,this.positionSpot="mm",this.positionType="pixel",this.absLeft=Math.round(50+50*Object.keys(a.watermarks).length),this.absTop=Math.round(50+50*Object.keys(a.watermarks).length),this.leftPercent=0,this.topPercent=0,this.url=e.url,this.styles={opacity:1,degree:0}};r=new n}return r}},{key:"updateWatermarkPlaceholderStyles",value:function(e,t,a){var r=a.type;if("image"===r)var i=e.find(".img-placeholder img");else{if("text"!==r)return;i=e.find(".watermark-text-textarea")}if(i.length){for(var n in t.font)"fontSize"===n?i.css(n,t.font[n]+"px"):i.css(n,t.font[n]);t.opacity&&i.css("opacity",t.opacity),i.width(a.width),i.height(a.height),t.degree&&this.rotateWatermarkElement(e,t.degree,r,a);var o=this.calculatePosition(a);e.css({left:o.left+"px",top:o.top+"px"})}}},{key:"rotateWatermarkElement",value:function(e,t,a,r){var i="rotate("+t+"deg)";r.centerOffset?(e.css("transform-origin","center center"),e.css("-ms-transform-origin","center center"),e.css("-webkit-transform-origin","center center")):(e.css("transform-origin","0px 0px"),e.css("-ms-transform-origin","0px 0px"),e.css("-webkit-transform-origin","0px 0px")),e.css("transform",i),e.css("-moz-transform",i),e.css("-webkit-transform",i),e.css("-o-transform",i)}},{key:"addWatermark",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"image",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if("image"===e){var s=this.initWaterMarkImg(t,n);this.watermarks[s.id]=s,a(document).trigger(i+"_preview_watermark_save_toggle",Object.keys(this.watermarks).length),this.drawWatermark(s,e,r,o)}else if("text"===e){var d=this.initWaterMarkText(n);this.watermarks[d.id]=d,a(document).trigger(i+"_preview_watermark_save_toggle",Object.keys(this.watermarks).length),this.drawWatermark(d,e,r,o)}a(".preview-watermark-preview-btn").removeClass("disabled").prop("disabled",!1)}},{key:"drawWatermark",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image",r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;e=this.drawWatermarkPlaceholder(e,t,r),"text"===t&&r&&(e=this.updateWatermarkTextOffsets(e)),r&&(this.insertWatermarkToList(e),this.openWatermarkSpecsAccordion(e.id)),i&&a("html, body").animate({scrollTop:a('.watermark-placeholder[item="'+e.id+'"]').offset().top-300},500)}},{key:"openWatermarkSpecsAccordion",value:function(e){var t=a('.accordion-button[data-id="'+e+'"]');t&&t.hasClass("collapsed")&&t.trigger("click")}},{key:"resetWatermarkPlaceholder",value:function(e){this.removeWatermark(e.id,!0),this.drawWatermarkPlaceholder(e,e.type,!1)}},{key:"drawWatermarkPlaceholder",value:function(e,r,i){var n=this,o=a(".watermark-"+r+"-placeholder-none").clone().removeClass("watermark-"+r+"-placeholder-none").removeClass("d-none").addClass("watermark-placeholder watermark-placeholder-"+r);o.attr("item",e.id),a(".selected-preview").after(o),this.setWatermarkStyles(e,o),this.watermarksElements[e.id]||(this.watermarksElements[e.id]={}),this.watermarksElements[e.id]=o;var s={containment:".preview-selected-wrapper",wheelRotate:!1,snap:!0,step:5,rotate:function(e,t){var r=a(e.target).attr("item"),i=Math.round(180*t.angle.current/Math.PI),o=n.watermarks[r],s=o.type;o.styles.degree=i,"text"===s&&(i<-90?(i=-90,t.angle.current=Math.PI*i/180):i>90&&(i=90,t.angle.current=Math.PI*i/180)),-0==i&&(i=0),n.updateWatermarkSpecs(r,{degree:i})},stop:function(e,r){var i=a(e.target).attr("item"),o=Math.round(180*r.angle.current/Math.PI),s=n.watermarks[i];s.styles.degree=o,"text"===s.type&&(s=n.updateWatermarkTextOffsets(s)),-0==o&&(o=0),n.updateWatermarkSpecs(i,{degree:o}),s=n.updateWatermark(s,t({degree:o},"degree",o))}};return o.rotatable(s),"text"===r&&i&&o.find(".watermark-text-textarea").text(e.text),e}},{key:"updateWatermarkSpecs",value:function(e,t){var r=a("#watermark-specs-item-"+e);t.width&&r.find(".edit-width").val(t.width),void 0!==t.height&&r.find(".edit-height").val(t.height),void 0!==t.positionType&&r.find("#gpls-wmfw-watermark-position-type-"+t.positionType).prop("checked",!0),void 0===t.left&&void 0===t.absLeft||r.find(".edit-position-left").val(t.left||t.absLeft),void 0===t.top&&void 0===t.absTop||r.find(".edit-position-top").val(t.top||t.absTop),void 0!==t.leftPercent&&r.find(".edit-position-left-percent").val(t.leftPercent),void 0!==t.topPercent&&r.find(".edit-position-top-percent").val(t.topPercent),void 0!==t.positionSpot&&r.find(".gpls-wmfw-watermark-position-spot-"+t.positionSpot).prop("checked",!0),void 0!==t.botLeft&&r.find(".edit-position-botleft").val(t.botLeft),void 0!==t.botTop&&r.find(".edit-position-bottop").val(t.botTop),void 0!==t.exactWidth&&r.find(".edit-position-exactwidth").val(t.exactWidth),void 0!==t.baselineOffset&&r.find(".edit-position-baselineoffset").val(t.baselineOffset),void 0!==t.degree&&r.find(".edit-degree").val(t.degree<0?360-Math.abs(t.degree):t.degree).trigger("change")}},{key:"setWatermarkStyles",value:function(e,t){"image"===e.type&&t.find(".img-placeholder img").attr("src",e.url);var a=t.find(".watermark-text-textarea");a.css("line-height"),"text"===e.type?(t.css({"font-family":e.styles.font.fontFamily,"font-size":e.styles.font.fontSize,width:"auto !important",height:"auto !important"}),a.css({color:e.styles.font.color})):"image"===e.type&&t.find("img").css({width:e.width,height:e.height}),t.position({my:"left top",at:"left top",of:"#selected-preview-container",collision:"fit"});var r=this.calculatePosition(e);t.css({left:r.left,top:r.top})}},{key:"repeatWatermarkPlaceholder",value:function(e){if(e.isRepeat&&e.repeatAxis.length){var t=s.width,a=s.height,r=parseInt(e.repeatXAxisOffset),i=parseInt(e.repeatYAxisOffset),n=this.calculatePosition(e);this.clearRepeatedPlaceholder(e.id);var o=n.left,d=n.top;if("x"===e.repeatAxis){if(r<=0)return;for(o+=r;o<t;)this.drawRepeatedPlaceholder(e,o,d),o+=r}else if("y"===e.repeatAxis){if(i<=0)return;for(d+=i;d<a;)this.drawRepeatedPlaceholder(e,o,d),d+=i}else if("diagonal"===e.repeatAxis){if(r>0&&i>0)for(;o<t&&d<a;)o+=r,d+=i,this.drawRepeatedPlaceholder(e,o,d)}else if("both"===e.repeatAxis){if(r>0){for(o+=r;o<t;)this.drawRepeatedPlaceholder(e,o,d),o+=r;o=n.left}if(i>0)for(d+=i;d<a;)this.drawRepeatedPlaceholder(e,o,d),d+=i}else if("full"===e.repeatAxis){if(o+=r,i<=0||r<=0)return;for(;d<a;){if(i>0){for(;o<t;)this.drawRepeatedPlaceholder(e,o,d),o+=r;o=n.left}d+=i}}}else this.clearRepeatedPlaceholder(e.id)}},{key:"drawRepeatedPlaceholder",value:function(e,t,r){var i=a('.watermark-placeholder[item="'+e.id+'"]'),n=i.find(".watermark-placeholder-wrapper"),o=n.clone();o.addClass("position-absolute w-auto repeat-clone repeat-clone-"+e.id),o.find(".watermark-text-textarea").css({background:"transparent",width:n.find(".watermark-text-textarea").width()}),"text"===e.type&&o.find(".watermark-text-textarea").attr("contenteditable",!1),o.css({width:i.width(),height:i.height(),left:t,top:r}),e.styles.degree&&this.rotateWatermarkElement(o,e.styles.degree,e.type,e),a("#selected-preview-container .repeated-clones-wrapper").append(o)}},{key:"clearRepeatedPlaceholder",value:function(e){a(".repeat-clone-"+e).remove()}},{key:"updateWatermarkTextOffsets",value:function(e){var t=Math.round(parseFloat(a('[item="'+e.id+'"]').find(".watermark-text-textarea").css("width"))),r=Math.round(parseFloat(a('[item="'+e.id+'"]').find(".watermark-text-textarea").css("height")));return e.width=t,e.height=r,e.botLeft=Math.round(e.absLeft)-Math.round(r*Math.sin(e.styles.degree*Math.PI/180)),e.botTop=Math.round(e.absTop)+Math.round(r*Math.cos(e.styles.degree*Math.PI/180)),this.directUpdateWatermark(e),this.updateWatermarkSpecs(e.id,{width:t,height:r,botTop:Math.round(e.botTop),botLeft:Math.round(e.botLeft)}),e}},{key:"removeWatermark",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];delete this.watermarks[e],delete this.watermarksElements[e],a(document).trigger(i+"_preview_watermark_save_toggle",Object.keys(this.watermarks).length);var r=a('.watermark-placeholder[item="'+e+'"]');r.remove(),a(".repeat-clone-"+e).remove(),t||(a("#"+e+"_header").remove(),a("#"+e+"_specs").remove(),a(".watermark-specs-header"))}},{key:"directUpdateWatermark",value:function(e){var t=e.id;this.watermarks[t]=e}},{key:"updateWatermark",value:function(e,t){return t.position&&(void 0!==t.position.positionType&&(e.positionType=t.position.positionType),void 0!==t.position.top&&(e.absTop=Math.round(t.position.top)),void 0!==t.position.left&&(e.absLeft=Math.round(t.position.left)),void 0!==t.position.positionSpot&&(e.positionSpot=t.position.positionSpot),void 0!==t.position.topPercent&&(e.topPercent=t.position.topPercent),void 0!==t.position.leftPercent&&(e.leftPercent=t.position.leftPercent),void 0!==t.position.centerOffset&&(e.centerOffset=t.position.centerOffset)),t.size&&(void 0!==t.size.width&&(e.width=t.size.width),void 0!==t.size.height&&(e.height=t.size.height)),t.text&&(e.text=t.text),t[i+"_updates_additional"]&&(e=Object.assign(e,t[i+"_updates_additional"])),t.degree&&(e.styles.degree=t.degree),void 0!==t.width&&(e.width=t.width),void 0!==t.height&&(e.height=t.height),this.watermarks[e.id]=e,e}},{key:"updateWatermarkStyles",value:function(e,t){if(c)return e;if("text"===e.type){var r=this.getTextHeight(t.font.fontFamily,t.font.fontSize,this.watermarksElements[e.id].text()),i=this.getTextWidth(t.font.fontFamily,t.font.fontSize,this.watermarksElements[e.id].text());e.baselineOffset=r.descent,e.exactWidth=i,this.updateWatermarkSpecs(e.id,{exactWidth:i,baselineOffset:r.descent})}return e.styles=a.extend(!0,e.styles,t),this.watermarks[e.id]=e,e}},{key:"displayWatermark",value:function(e){var t=a(".watermark-item"),r=e.url;t.find("img").attr("src",r),t.removeClass("d-none")}},{key:"initImage",value:function(){var e=this;a(".selected-preview").attr("src",s.url),a(".selected-preview").on("load",(function(){e.createPreviewOverlayers(),e.initCurrentWatermarks(!1)}))}},{key:"createPreviewOverlayers",value:function(){var e='<div class="preview-overlayer" width="'+s.width+'" height="'+s.height+'"></div>',t=a(".selected-preview");t.after(e),s.width=Math.floor(t.width()),s.height=Math.floor(t.height())}},{key:"previewWatermarks",value:function(e){var t=this;e.preventDefault(),a(".preview-result").addClass("d-none"),a(".img-media-icon-box").remove();var r=a(e.target);this.loading(r,!0);var i=Object.values(this.watermarks),o={action:n.previewWatermarkstemplateAction,nonce:n.nonce,preview_img:s,watermarks:i};a.ajax({method:"POST",url:n.ajaxUrl,dataType:"json",data:o,success:function(e){var a;null!=e&&null!==(a=e.data)&&void 0!==a&&a.msg&&v(e.data.msg,"bg-"+e.data.status),e.success&&t.displayPreview(e.data.result)},error:function(e){var t;null!=e&&null!==(t=e.data)&&void 0!==t&&t.msg&&v(e.data.msg,"bg-danger")},complete:function(){t.loading(r,!1)}})}},{key:"displayPreview",value:function(e){var t=a(".preview-result");t.find(".preview-img").attr("src",e),t.removeClass("d-none")}},{key:"displayGifIcon",value:function(e){var t=a(".gif-icon-box-container");t.html(e),t.removeClass("d-none")}},{key:"loading",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t?(e.addClass("disabled").prop("disabled",!0),e.siblings(".spinner").addClass("is-active")):(e.removeClass("disabled").prop("disabled",!1),e.siblings(".spinner").removeClass("is-active disabled"))}},{key:"rgba2hex",value:function(e){return"#".concat(e.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+\.{0,1}\d*))?\)$/).slice(1).map((function(e,t){return(3===t?Math.round(255*parseFloat(e)):parseFloat(e)).toString(16).padStart(2,"0").replace("NaN","")})).join(""))}},{key:"getTextHeight",value:function(e,t,r){r=a("<span>"+a.trim(r)+"</span>").css({fontFamily:e,fontSize:t+"px"});var i=a('<div style="display: inline-block; width: 1px; height: 0px;"></div>'),n=a("<div></div>");n.append(r,i),a("body").append(n);try{var o={};i.css({verticalAlign:"baseline"}),o.ascent=i.offset().top-r.offset().top,i.css({verticalAlign:"bottom"}),o.height=i.offset().top-r.offset().top,o.descent=o.height-o.ascent}finally{n.remove()}return o}},{key:"getTextWidth",value:function(e,t,r){var i=this.canvas.getContext("2d");i.font=Math.round(parseInt(t))+"px "+e;var n=i.measureText(a.trim(r));return Math.round(Math.abs(n.actualBoundingBoxRight)-Math.abs(n.actualBoundingBoxLeft))}},{key:"getFilterRow",value:function(e,t,r){e.attr("disabled",!0),e.siblings(".spinner").addClass("visible"),a.ajax({method:"POST",url:n.ajaxUrl,data:{action:n.filterRowPlaceholderAction,cpt_slug:t,counter:"group-"+r},success:function(t){if(t.data.length){var i=a(t.data);e.siblings(".context-by-cpt-filter").append(i),i.find(".cpt-terms-select").each((function(e){f(a(this).attr("id"),a(this).data("cpt"),a(this).data("tax"))})),u(i.find(".cpt-author-select").attr("id")),e.data("counter",parseInt(r)+1)}},error:function(e){var t;null!=e&&null!==(t=e.data)&&void 0!==t&&t.msg&&v(e.data.msg,"bg-danger")},complete:function(){e.attr("disabled",!1),e.siblings(".spinner").removeClass("visible")}})}}],w&&e(h.prototype,w),Object.defineProperty(h,"prototype",{writable:!1}),d}();function f(e,t,r){var i=a("#"+e);i.length&&i.select2({placeholder:n.labels.search_term,width:"200px",cache:!0,multiple:!1,allowClear:!0,ajax:{method:"post",url:n.ajaxUrl,dataType:"json",delay:500,data:function(e){return{term:e.term,cpt:t,tax:r,action:n.searchCPTTermsAction}},processResults:function(e){var t=[];return e.data.length&&(t=e.data),{results:t}}},minimumInputLength:3})}function u(e){var t=a("#"+e);t.length&&t.select2({placeholder:n.labels.search_author,width:"200px",cache:!0,multiple:!1,allowClear:!0,ajax:{method:"post",url:n.ajaxUrl,dataType:"json",delay:500,data:function(e){return{author_name:e.term,action:n.searchAuthorAction}},processResults:function(e){var t=[];return e.data.length&&(t=e.data),{results:t}}},minimumInputLength:3})}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bg-primary",r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=a("."+n.classes_prefix+"-msgs-toast");i.removeClass((function(e,t){return(t.match(/(^|\s)bg-\S+/g)||[]).join(" ")}));var o="";r?(o='<ul class="toast-notice-list">',e.forEach((function(e){o+='<li class="notice-item"><p>'+e+"</p></li>"})),o+="</ul>"):o="<p>"+e+"</p>",i.addClass(t).find(".toast-body").html(o),i.toast("show")}}(jQuery)})();